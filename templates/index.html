{% extends "base.html" %}

{% block content %}
<!-- Hero Section -->
<section class="hero-section">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8 text-center">
                <h1 class="display-4 fw-bold text-white mb-4">TomatoDoc AI</h1>
                <p class="lead text-white mb-4">Sistem Deteksi Penyakit Daun Tomat Menggunakan Kecerdasan Buatan</p>
                <p class="text-white mb-4">Upload foto daun tomat untuk mendapatkan diagnosis penyakit secara otomatis</p>
                
                <!-- Informasi Kegunaan Sistem -->
                <div class="row mt-5">
                    <div class="col-md-4 mb-3">
                        <div class="card h-100 border-0 shadow-sm">
                            <div class="card-body text-center">
                                <i class="fas fa-microscope fa-3x text-primary mb-3"></i>
                                <h5>Diagnosis Akurat</h5>
                                <p class="text-muted">Deteksi 10+ jenis penyakit tomat dengan akurasi 73% menggunakan teknologi Random Forest</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="card h-100 border-0 shadow-sm">
                            <div class="card-body text-center">
                                <i class="fas fa-clock fa-3x text-success mb-3"></i>
                                <h5>Hasil Instan</h5>
                                <p class="text-muted">Dapatkan hasil analisis dalam hitungan detik dengan rekomendasi penanganan yang tepat</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="card h-100 border-0 shadow-sm">
                            <div class="card-body text-center">
                                <i class="fas fa-leaf fa-3x text-warning mb-3"></i>
                                <h5>Panduan Lengkap</h5>
                                <p class="text-muted">Informasi detail tentang gejala, penyebab, penanganan, dan pencegahan penyakit</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Cara Penggunaan -->
                <div class="mt-5">
                    <h4 class="text-white mb-4">Cara Menggunakan Sistem</h4>
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <div class="text-center">
                                <div class="bg-primary text-white rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                                    <span class="fw-bold fs-4">1</span>
                                </div>
                                <h6 class="mt-3 text-white">Ambil Foto</h6>
                                <p class="text-white-50 small">Foto daun tomat dengan pencahayaan yang baik</p>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="text-center">
                                <div class="bg-success text-white rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                                    <span class="fw-bold fs-4">2</span>
                                </div>
                                <h6 class="mt-3 text-white">Upload Gambar</h6>
                                <p class="text-white-50 small">Pilih file gambar dari perangkat Anda</p>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="text-center">
                                <div class="bg-warning text-white rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                                    <span class="fw-bold fs-4">3</span>
                                </div>
                                <h6 class="mt-3 text-white">Analisis AI</h6>
                                <p class="text-white-50 small">Sistem akan menganalisis gambar secara otomatis</p>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="text-center">
                                <div class="bg-info text-white rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                                    <span class="fw-bold fs-4">4</span>
                                </div>
                                <h6 class="mt-3 text-white">Dapatkan Hasil</h6>
                                <p class="text-white-50 small">Lihat diagnosis dan rekomendasi penanganan</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Upload Section -->
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-upload me-2"></i>
                    Upload Foto Daun Tomat
                </div>
                <div class="card-body">
                    <form id="uploadForm" enctype="multipart/form-data">
                        <div class="upload-area" id="uploadArea">
                            <div class="upload-content" id="uploadContent">
                                <i class="fas fa-cloud-upload-alt upload-icon"></i>
                                <h4>Upload Foto Daun Tomat</h4>
                                <p class="text-muted">Seret & lepas atau klik untuk memilih gambar</p>
                                <input type="file" id="imageInput" accept="image/*" style="display: none;">
                                <button type="button" class="btn btn-primary" onclick="document.getElementById('imageInput').click()">
                                    <i class="fas fa-plus me-2"></i>Pilih Gambar
                                </button>
                            </div>
                            
                            <div class="preview-container" id="previewContainer" style="display: none;">
                                <img id="previewImage" src="" alt="Preview" class="preview-image">
                                <div class="preview-actions mt-3">
                                    <button type="button" class="btn btn-success btn-lg me-2" onclick="analyzeImage()">
                                        <i class="fas fa-search me-2"></i>Analisis Gambar
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="resetUpload()">
                                        <i class="fas fa-times me-2"></i>Ganti Gambar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                    
                    <!-- Loading Spinner -->
                    <div class="loading-spinner" id="loadingSpinner">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Menganalisis gambar...</p>
                    </div>
                </div>
            </div>

            <!-- Results Section -->
            <div id="resultsSection" style="display: none;">
                <div class="card result-card">
                    <div class="card-header">
                        <i class="fas fa-chart-line me-2"></i>
                        Hasil Analisis
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 text-center mb-3">
                                <img id="resultImage" src="" alt="Analyzed Image" class="img-fluid rounded shadow">
                            </div>
                            <div class="col-md-8">
                                <div id="diseaseResult">
                                    <!-- Results will be populated here -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Detailed Probabilities -->
                        <div class="mt-4">
                            <h5><i class="fas fa-chart-bar me-2"></i>Detail Probabilitas Semua Penyakit</h5>
                            <div id="probabilitiesChart">
                                <!-- Probabilities will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Diagnosis Utama -->
                <div class="card mb-3 border-primary mt-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-stethoscope me-2"></i>Diagnosis Utama</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <h4 id="disease-name" class="text-primary mb-3"></h4>
                                <div class="mb-3">
                                    <h6>Tingkat Kepercayaan:</h6>
                                    <div class="progress mb-2" style="height: 25px;">
                                        <div id="confidence-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar"></div>
                                    </div>
                                    <p id="confidence-text" class="mb-0"></p>
                                </div>
                                <div id="recommendations-section">
                                    <h6><i class="fas fa-lightbulb me-2"></i>Rekomendasi:</h6>
                                    <ul id="recommendations-list" class="list-unstyled"></ul>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div id="severity-badge" class="text-center mb-3"></div>
                                <div id="urgency-info" class="alert alert-info text-center"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Informasi Detail -->
                <div class="row">
                    <!-- Deskripsi -->
                    <div class="col-md-6 mb-3">
                        <div class="card h-100">
                            <div class="card-header bg-info text-white">
                                <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Deskripsi</h6>
                            </div>
                            <div class="card-body">
                                <p id="disease-description" class="mb-0"></p>
                            </div>
                        </div>
                    </div>

                    <!-- Gejala -->
                    <div class="col-md-6 mb-3">
                        <div class="card h-100">
                            <div class="card-header bg-warning text-dark">
                                <h6 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Gejala</h6>
                            </div>
                            <div class="card-body">
                                <ul id="symptoms-list" class="list-unstyled mb-0"></ul>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <!-- Penyebab -->
                    <div class="col-md-6 mb-3">
                        <div class="card h-100">
                            <div class="card-header bg-danger text-white">
                                <h6 class="mb-0"><i class="fas fa-bug me-2"></i>Penyebab</h6>
                            </div>
                            <div class="card-body">
                                <ul id="causes-list" class="list-unstyled mb-0"></ul>
                            </div>
                        </div>
                    </div>

                    <!-- Penanganan -->
                    <div class="col-md-6 mb-3">
                        <div class="card h-100">
                            <div class="card-header bg-success text-white">
                                <h6 class="mb-0"><i class="fas fa-medkit me-2"></i>Penanganan</h6>
                            </div>
                            <div class="card-body">
                                <ul id="treatment-list" class="list-unstyled mb-0"></ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pencegahan -->
                <div class="card mb-3">
                    <div class="card-header bg-secondary text-white">
                        <h6 class="mb-0"><i class="fas fa-shield-alt me-2"></i>Pencegahan</h6>
                    </div>
                    <div class="card-body">
                        <ul id="prevention-list" class="list-unstyled mb-0"></ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Info Cards -->
    <div class="row mt-5">
        <div class="col-md-4 mb-4">
            <div class="card h-100">
                <div class="card-body text-center">
                    <div class="mb-3">
                        <i class="fas fa-brain" style="font-size: 3rem; color: var(--accent-color);"></i>
                    </div>
                    <h5>Machine Learning</h5>
                    <p class="text-muted">Menggunakan algoritma Random Forest yang dilatih dengan ribuan gambar daun tomat</p>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-4">
            <div class="card h-100">
                <div class="card-body text-center">
                    <div class="mb-3">
                        <i class="fas fa-eye" style="font-size: 3rem; color: var(--accent-color);"></i>
                    </div>
                    <h5>Computer Vision</h5>
                    <p class="text-muted">Analisis fitur visual seperti warna, tekstur, dan pola untuk identifikasi penyakit</p>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-4">
            <div class="card h-100">
                <div class="card-body text-center">
                    <div class="mb-3">
                        <i class="fas fa-seedling" style="font-size: 3rem; color: var(--accent-color);"></i>
                    </div>
                    <h5>10 Jenis Penyakit</h5>
                    <p class="text-muted">Dapat mendeteksi berbagai penyakit tomat termasuk bacterial spot, early blight, dan lainnya</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let selectedFile = null;
    
    const uploadArea = document.getElementById('uploadArea');
    const imageInput = document.getElementById('imageInput');
    const previewContainer = document.getElementById('previewContainer');
    const previewImage = document.getElementById('previewImage');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const resultsSection = document.getElementById('resultsSection');

    // Drag and drop functionality
    uploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            imageInput.files = files;
            handleFileSelect(files[0]);
        }
    });

    // File input change
    imageInput.addEventListener('change', function(e) {
        if (e.target.files.length > 0) {
            handleFileSelect(e.target.files[0]);
        }
    });

    // Handle file selection
    function handleFileSelect(file) {
        if (file && file.type.startsWith('image/')) {
            selectedFile = file;
            showPreview(file);
        } else {
            alert('Silakan pilih file gambar yang valid.');
        }
    }
    
    // Show preview function
    function showPreview(file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            previewImage.src = e.target.result;
            document.querySelector('.upload-content').style.display = 'none';
            previewContainer.style.display = 'block';
        };
        reader.readAsDataURL(file);
    }
    
    // Analyze image function
    window.analyzeImage = function() {
        if (!selectedFile) {
            alert('Silakan pilih gambar terlebih dahulu.');
            return;
        }

        const formData = new FormData();
        formData.append('file', selectedFile);

        // Show loading spinner
        loadingSpinner.style.display = 'block';
        resultsSection.style.display = 'none';

        fetch('/upload', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            loadingSpinner.style.display = 'none';
            if (data.error) {
                alert('Error: ' + data.error);
                return;
            }
            
            // Tampilkan diagnosis utama
            document.getElementById('disease-name').textContent = data.disease;
            document.getElementById('confidence-text').textContent = 
                `${(data.confidence * 100).toFixed(1)}% (${data.confidence_level})`;
            
            // Update progress bar
            const progressBar = document.getElementById('confidence-bar');
            const percentage = (data.confidence * 100).toFixed(1);
            progressBar.style.width = percentage + '%';
            progressBar.textContent = percentage + '%';
            
            // Set warna berdasarkan tingkat kepercayaan
            progressBar.className = 'progress-bar progress-bar-striped progress-bar-animated';
            if (data.confidence > 0.8) {
                progressBar.classList.add('bg-success');
            } else if (data.confidence > 0.6) {
                progressBar.classList.add('bg-warning');
            } else {
                progressBar.classList.add('bg-danger');
            }
            
            // Tampilkan rekomendasi
            const recommendationsList = document.getElementById('recommendations-list');
            recommendationsList.innerHTML = '';
            if (data.recommendations && data.recommendations.length > 0) {
                data.recommendations.forEach(rec => {
                    const li = document.createElement('li');
                    li.innerHTML = `<i class="fas fa-check-circle text-success me-2"></i>${rec}`;
                    li.className = 'mb-2';
                    recommendationsList.appendChild(li);
                });
            }
            
            // Tampilkan severity badge
            const severityBadge = document.getElementById('severity-badge');
            let badgeClass = 'badge fs-6 p-3';
            if (data.severity === 'Tinggi') {
                badgeClass += ' bg-danger';
            } else if (data.severity === 'Sedang') {
                badgeClass += ' bg-warning text-dark';
            } else {
                badgeClass += ' bg-success';
            }
            severityBadge.innerHTML = `<span class="${badgeClass}">Tingkat Keparahan: ${data.severity || 'Normal'}</span>`;
            
            // Tampilkan urgency
            document.getElementById('urgency-info').innerHTML = 
                `<i class="fas fa-clock me-2"></i><strong>Tindakan:</strong> ${data.urgency || 'Pemantauan rutin'}`;
            
            // Tampilkan deskripsi
            document.getElementById('disease-description').textContent = data.description;
            
            // Tampilkan gejala
            const symptomsList = document.getElementById('symptoms-list');
            symptomsList.innerHTML = '';
            if (data.symptoms && data.symptoms.length > 0) {
                data.symptoms.forEach(symptom => {
                    const li = document.createElement('li');
                    li.innerHTML = `<i class="fas fa-dot-circle text-warning me-2"></i>${symptom}`;
                    li.className = 'mb-1';
                    symptomsList.appendChild(li);
                });
            } else {
                symptomsList.innerHTML = '<li class="text-muted">Tidak ada gejala spesifik</li>';
            }
            
            // Tampilkan penyebab
            const causesList = document.getElementById('causes-list');
            causesList.innerHTML = '';
            if (data.causes && data.causes.length > 0) {
                data.causes.forEach(cause => {
                    const li = document.createElement('li');
                    li.innerHTML = `<i class="fas fa-arrow-right text-danger me-2"></i>${cause}`;
                    li.className = 'mb-1';
                    causesList.appendChild(li);
                });
            } else {
                causesList.innerHTML = '<li class="text-muted">Penyebab tidak spesifik</li>';
            }
            
            // Tampilkan penanganan
            const treatmentList = document.getElementById('treatment-list');
            treatmentList.innerHTML = '';
            if (data.treatment && data.treatment.length > 0) {
                data.treatment.forEach(treatment => {
                    const li = document.createElement('li');
                    li.innerHTML = `<i class="fas fa-check text-success me-2"></i>${treatment}`;
                    li.className = 'mb-1';
                    treatmentList.appendChild(li);
                });
            } else {
                treatmentList.innerHTML = '<li class="text-muted">Konsultasi dengan ahli pertanian</li>';
            }
            
            // Tampilkan pencegahan
            const preventionList = document.getElementById('prevention-list');
            preventionList.innerHTML = '';
            if (data.prevention && data.prevention.length > 0) {
                data.prevention.forEach(prevention => {
                    const li = document.createElement('li');
                    li.innerHTML = `<i class="fas fa-shield-alt text-secondary me-2"></i>${prevention}`;
                    li.className = 'mb-1';
                    preventionList.appendChild(li);
                });
            } else {
                preventionList.innerHTML = '<li class="text-muted">Praktik pertanian yang baik</li>';
            }
            
            displayResults(data);
        })
        .catch(error => {
            loadingSpinner.style.display = 'none';
            alert('Error saat menganalisis gambar: ' + error);
        });
    };

    // Form submission
    uploadForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData();
        const file = fileInput.files[0];
        
        if (!file) {
            alert('Please select an image first.');
            return;
        }
        
        formData.append('file', file);
        
        // Show loading
        loadingSpinner.style.display = 'block';
        resultsSection.style.display = 'none';
        
        // Submit to server
        fetch('/upload', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            loadingSpinner.style.display = 'none';
            
            if (data.error) {
                alert('Error: ' + data.error);
                return;
            }
            
            displayResults(data);
        })
        .catch(error => {
            loadingSpinner.style.display = 'none';
            console.error('Error:', error);
            alert('An error occurred while processing the image.');
        });
    });

    // Display results
    function displayResults(data) {
        const resultImage = document.getElementById('resultImage');
        const diseaseResult = document.getElementById('diseaseResult');
        const probabilitiesChart = document.getElementById('probabilitiesChart');
        
        // Set result image
        resultImage.src = '/static/' + data.image_path;
        
        // Determine if healthy or diseased
        const isHealthy = data.disease.toLowerCase().includes('healthy');
        const badgeClass = isHealthy ? 'healthy-badge' : '';
        
        // Create disease result HTML
        diseaseResult.innerHTML = `
            <div class="disease-badge ${badgeClass}">
                <i class="fas ${isHealthy ? 'fa-check-circle' : 'fa-exclamation-triangle'} me-2"></i>
                ${data.disease}
            </div>
            <div class="mb-3">
                <h6>Tingkat Kepercayaan: ${data.confidence_level}</h6>
                <div class="confidence-bar">
                    <div class="confidence-fill" style="width: ${(data.confidence * 100).toFixed(1)}%"></div>
                </div>
                <small class="text-muted">${(data.confidence * 100).toFixed(1)}%</small>
            </div>
            <div class="alert ${isHealthy ? 'alert-success' : 'alert-warning'}">
                <h6><i class="fas fa-info-circle me-2"></i>Deskripsi & Penanganan:</h6>
                <p class="mb-0">${data.description}</p>
            </div>
        `;
        
        // Create probabilities chart
        let chartHTML = '';
        const sortedProbs = Object.entries(data.all_probabilities)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 5); // Show top 5
        
        sortedProbs.forEach(([disease, prob]) => {
            const percentage = (prob * 100).toFixed(1);
            chartHTML += `
                <div class="mb-2">
                    <div class="d-flex justify-content-between">
                        <span>${disease}</span>
                        <span>${percentage}%</span>
                    </div>
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar" style="width: ${percentage}%; background: linear-gradient(90deg, var(--accent-color) 0%, var(--primary-color) 100%);"></div>
                    </div>
                </div>
            `;
        });
        
        probabilitiesChart.innerHTML = chartHTML;
        
        // Show results with animation
        resultsSection.style.display = 'block';
        resultsSection.classList.add('fade-in');
        
        // Scroll to results
        resultsSection.scrollIntoView({ behavior: 'smooth' });
    }

    // Reset upload
    window.resetUpload = function() {
        selectedFile = null;
        imageInput.value = '';
        document.querySelector('.upload-content').style.display = 'block';
        previewContainer.style.display = 'none';
        resultsSection.style.display = 'none';
        loadingSpinner.style.display = 'none';
    };
});
</script>
{% endblock %}